(()=>{"use strict";var e={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},d:(n,t)=>{for(var l in t)e.o(t,l)&&!e.o(n,l)&&Object.defineProperty(n,l,{enumerable:!0,get:t[l]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=window.React;var t=e.n(n);const l=window.wp.htmlEntities,o=window.wc.wcBlocksRegistry,a=window.wc.wcSettings;var s=function(e,n,t,l){return new(t||(t=Promise))((function(o,a){function s(e){try{i(l.next(e))}catch(e){a(e)}}function r(e){try{i(l.throw(e))}catch(e){a(e)}}function i(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,r)}i((l=l.apply(e,n||[])).next())}))};const r=(0,a.getSetting)("ledyer_payments_data",{}),i=r.title||"Ledyer Payments",c=r.enabled||!1,u=r.description||"",d=r.iconurl||!1,m=r.ledyerpaymentsparams||{},p=({organizationNumber:e,props:t})=>{const{onCheckoutSuccess:l}=t.eventRegistration,{emitResponse:o}=t,{billingData:a}=t.billing,{shippingAddress:r}=t.shippingData;return(0,n.useEffect)((()=>l((n=>s(void 0,void 0,void 0,(function*(){const{orderId:t}=n,l=n.processingResponse.paymentDetails.order_key;return yield y(t,l,e,a,r,o)}))))),[l]),null},y=(e,n,t,l,o,a)=>s(void 0,void 0,void 0,(function*(){var s;const r=null===(s=t.current)||void 0===s?void 0:s.value.trim();if(!r||!r.length)return{type:a.responseTypes.ERROR,message:"Company number is missing.",messageContext:a.noticeContexts.CHECKOUT};const{sessionId:i}=m,c=v(e,l,o,r,i),u=yield window.ledyer.payments.api.authorize(c);if(u){if("authorized"===u.state){const e=u.authorizationToken,{state:t}=u,{createOrderUrl:l,createOrderNonce:o}=m;try{const s=yield fetch(l,{method:"POST",body:new URLSearchParams({state:t,order_key:n,billing_company_number:r,auth_token:e,nonce:o})}),i=yield s.json(),{data:{location:c}}=i;return window.location=c,{type:a.responseTypes.SUCCESS}}catch(e){return{type:a.responseTypes.ERROR,message:"The payment was successful, but the order could not be created.",messageContext:a.noticeContexts.CHECKOUT}}}else if("awaitingSignatory"===u.state){const{pendingPaymentUrl:e,pendingPaymentNonce:t}=m;try{const l=yield fetch(e,{method:"POST",body:new URLSearchParams({order_key:n,nonce:t})}),o=yield l.json(),{data:{location:s}}=o;return window.location=s,{type:a.responseTypes.SUCCESS}}catch(e){return{type:a.responseTypes.ERROR,message:"The payment is pending payment. Failed to redirect to order received page.",messageContext:a.noticeContexts.CHECKOUT}}}return{type:a.responseTypes.ERROR,message:"The payment was not successful. Not authorized.",messageContext:a.noticeContexts.CHECKOUT}}return{type:a.responseTypes.ERROR,message:"The payment was not successful. Not authorization response received.",messageContext:a.noticeContexts.CHECKOUT}})),v=(e,n,t,l,o)=>({customer:{companyId:l||null,email:(null==n?void 0:n.email)||null,firstName:(null==n?void 0:n.first_name)||null,lastName:(null==n?void 0:n.last_name)||null,phone:(null==n?void 0:n.phone)||null,reference1:e.toString()||null,reference2:"",billingAddress:{attentionName:(null==n?void 0:n.first_name)||null,city:(null==n?void 0:n.city)||null,companyName:(null==n?void 0:n.company)||null,country:(null==n?void 0:n.country)||null,postalCode:(null==n?void 0:n.postcode)||null,streetAddress:(null==n?void 0:n.address_1)||null},shippingAddress:{attentionName:(null==t?void 0:t.first_name)||null,city:(null==t?void 0:t.city)||null,companyName:(null==t?void 0:t.company)||null,country:(null==t?void 0:t.country)||null,postalCode:(null==t?void 0:t.postcode)||null,streetAddress:(null==t?void 0:t.address_1)||null,contact:{email:(null==n?void 0:n.email)||null,firstName:(null==t?void 0:t.first_name)||null,lastName:(null==t?void 0:t.last_name)||null,phone:(null==t?void 0:t.phone)||null}}},sessionId:o||null}),g=e=>{const o=(0,n.useRef)(null);return t().createElement("div",null,t().createElement("p",null,(0,l.decodeEntities)(u)),t().createElement(p,{props:e,organizationNumber:o}),t().createElement("input",{type:"text",className:"input-text",name:"billing_company_number_block",id:"billing_company_number_block",placeholder:"Company number",defaultValue:"",ref:o,required:!0}))},h={name:"ledyer_payments",label:t().createElement((()=>{const e=d?t().createElement("img",{src:d,alt:i}):null;return t().createElement("span",{className:"lp-block-label"},e,i)}),null),content:t().createElement(g,null),edit:t().createElement(g,null),placeOrderButtonLabel:"Pay with Ledyer",canMakePayment:()=>c,ariaLabel:i};(0,o.registerPaymentMethod)(h)})();